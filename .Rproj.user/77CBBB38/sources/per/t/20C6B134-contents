---
title: "Pipeline analysis of *C. trachomatis* MAP data - October 2020"
output: html_notebook
---


```{r}
library(tidyverse)
library(here)
library(zoo)
source(here("MAP_functions.R"))
```

**"regular"** is a statistic I developed after seeing that the Ref_cov+alternate bases did not always quite equal the total coverage.  In most cases, regular = 0, which means that the coverages do add up. There are a few bases +1 or -1.  Fewer still have greater deviaiotn but a few positions have huge deviation +/1 3000nt which probably is an indication of weird mapping problems.

**pot_true_minors** means that coverage is at least 10, "regular" is -1,0 or 1 and there are alternate SNPs that fall between 0.1 and 0.9 allele frequency (this is what *SNP_percent* means).

**pot_true_SNP** means that coverage is at least 10, "regular" is -1,0 or 1 and there are alternate SNPs that fall below 0.1 and 0.9 allele frequency (ie dominated by the alternative, nonAST allele).

**cov10** means number of bases with 10 or above coverage

**map_value1** means "map_value" (Sandeep's statistic meaning percent of the highest coverage) is 1 or less. All bases *should* be 1 or less but a few have weirdness.

```{r}
MAP_file_info <- file.info(list.files("~/Box/TIMOTHY_READ/DATA/2020-Chlamydia_Agilent_project/MAP_ASR/",full.names = T,pattern = "*.txt"))
MAP_files <- list.files("~/Box/TIMOTHY_READ/DATA/2020-Chlamydia_Agilent_project/MAP_ASR/",full.names = T,pattern = "*.txt")
MAP_files <- MAP_files[MAP_file_info$size > 1000000]
out_dir <- "~/Desktop/MAP_out_files/"
```

```{r}
for (i in seq_along(MAP_files)){
loop_file <- MAP_files[i]
f_name <- sub("_MAP.txt","",sub("//","",regmatches(loop_file, regexpr("//.{3,10}_MAP.txt", loop_file))))
MAP <- read_MAP(loop_file,f_name)
MAP_stats <- MAP_stats_summary(MAP,out_dir,f_name)
plot_MAP_histo(MAP,out_dir,f_name)
plot_MAP_coverage(MAP,out_dir,f_name)
write_potential_minors(MAP,out_dir,f_name)
write_potential_SNPs(MAP,out_dir,f_name)
}

```


## Create summary table
```{r}
MAP_summaries <- list.files("~/Box/TIMOTHY_READ/DATA/2020-Chlamydia_Agilent_project/MAP_ASR/MAP_out_files/",full.names = T,pattern = "*_stats.tsv")
```
`

```{r}
MAP_summary_df <- read_tsv(MAP_summaries[1])
for (j in 2:length(MAP_summaries)) {
  temp_df <- read_tsv(MAP_summaries[j])
  MAP_summary_df <- bind_rows(MAP_summary_df,temp_df)
}
write_tsv(MAP_summary_df,here("MAP_analysis_summary.tsv"))
```

### Take a look at high quality data

```{r}
MAP_summary_df %>%
  filter(cov10 > 1030000) %>%
  ggplot(aes(pot_true_minors)) +
  geom_histogram(binwidth=100) +
    ggtitle("No of strains with potential true minor alleles") +
    theme_bw()
```
```{r}
MAP_summary_df %>%
  filter(cov10 > 1030000) %>%
  filter(pot_true_minors > 200)
```



## Aggregate minor alleles

```{r}
MAP_minor_allele_files <- list.files("~/Box/TIMOTHY_READ/DATA/2020-Chlamydia_Agilent_project/MAP_ASR/MAP_out_files/",full.names = T,pattern = "*_minors.tsv")
```
`
```{r}
MAP_minor_allele_df <- read_tsv(MAP_minor_allele_files[1],col_types=(cols(
  strain = col_character(),
  Position = col_integer(),
  Refnt = col_character(),
  Coverage = col_integer(),
  Ref_cov = col_integer(),
  Aa = col_integer(),
  Gg = col_integer(),
  Cc = col_integer(),
  Tt = col_integer())
))
for (j in 2:length(MAP_minor_allele_files)) {
  temp_df2 <- read_tsv(MAP_minor_allele_files[j],col_types=(cols(
  strain = col_character(),
  Position = col_integer(),
  Refnt = col_character(),
  Coverage = col_integer(),
  Ref_cov = col_integer(),
  Aa = col_integer(),
  Gg = col_integer(),
  Cc = col_integer(),
  Tt = col_integer())
))
  MAP_minor_allele_df <- bind_rows(MAP_minor_allele_df,temp_df2)
}
write_tsv(MAP_minor_allele_df,here("MAP_minor_alleles_df.tsv"))
```

Find common and rare mutations


```{r}
Posiiotn_count <- MAP_minor_allele_df %>%
  group_by(Position) %>%
  tally
ggplot(Posiiotn_count,aes(n)) + 
    geom_histogram(binwidth=1) +
    ggtitle("No of strains with minor allele") +
    theme_bw()
```
This show that by far the majority of minor alleles are rare (found in 10 strains or fewer)

Next step maybe to see if common minor alelles explain most of the minor alleles in strain with < 200

```{r}

minor_mutation_summary <- MAP_minor_allele_df %>%
  mutate(Altnt = case_when(
    Aa > Gg | Aa > Cc | Aa > Tt ~ "A",
    Gg > Aa | Gg > Cc | Gg > Tt ~ "G",
    Cc > Aa | Cc > Gg | Cc > Tt ~ "C",
    Tt > Aa | Tt > Gg | Tt > Cc ~ "T",
    TRUE ~ NA
  ))

```


