---
title: "R Notebook"
output: html_notebook
---

---
title: "SNP pipeline analysis of subjects with 3 body site results"
output: html_notebook
---



```{r}
library(tidyverse)
source("MAP_functions.R")
```

### Subject 26
```{r}
SNP_analysis_pipeline(subject_id = 26)
```
### Subject 32
```{r}
SNP_analysis_pipeline(subject_id = 32)
```

### Subject 68
```{r}
SNP_analysis_pipeline(subject_id = 68)
```

### Subject 72
```{r}
SNP_analysis_pipeline(subject_id = 72)
```

### Subject 87
```{r}
SNP_analysis_pipeline(subject_id = 87)
```

### Subject 98
```{r}
SNP_analysis_pipeline(subject_id = 98)
```

### Subject 107
```{r}
SNP_analysis_pipeline(subject_id = 107)
```

### Subject 192
```{r}
SNP_analysis_pipeline(subject_id = 192)
```

### Subject 227
```{r}
SNP_analysis_pipeline(subject_id = 227)
```

### Subject 362
```{r}
SNP_analysis_pipeline(subject_id = 362)
```

### Subject 519
```{r}
SNP_analysis_pipeline(subject_id = 519)
```

### Subject 564
```{r}
SNP_analysis_pipeline(subject_id = 564)
```

### Subject 753
```{r}
SNP_analysis_pipeline(subject_id = 753)
```

### Subject 908
```{r}
SNP_analysis_pipeline(subject_id = 908)
```

### Subject 927
```{r}
SNP_analysis_pipeline(subject_id = 927)
```

### Subject 951
```{r}
SNP_analysis_pipeline(subject_id = 951)
```


### Subject 968
```{r}
SNP_analysis_pipeline(subject_id = 968)
```


### Subject 1077
```{r}
SNP_analysis_pipeline(subject_id = 1077)
```

### Subject 1078
```{r}
SNP_analysis_pipeline(subject_id = 1078)
```

### Subject 1079
```{r}
SNP_analysis_pipeline(subject_id = 1079)
```

### Subject 1106
```{r}
SNP_analysis_pipeline(subject_id = 1106)
```

### Subject 1145
```{r}
SNP_analysis_pipeline(subject_id = 1145)
```

### Subject 1176
```{r}
SNP_analysis_pipeline(subject_id = 1176)
```

### Subject 1182
```{r}
SNP_analysis_pipeline(subject_id = 1182)
```

### Subject 1201
```{r}
SNP_analysis_pipeline(subject_id = 1201)
```

### Subject 1226
```{r}
SNP_analysis_pipeline(subject_id = 1226)
```

# POst SNP analysis 
```{r}
res_files <- list.files("./iSNP_analysis_table/",full.names = T, pattern = "iSNP*")
res_table <- read.delim(res_files[1])
for (i in 2:length(res_files)){
  temp_df <- read.delim(res_files[i])
  res_table <- bind_rows(res_table,temp_df)
}
```

```{r}
write_tsv(res_table,"./iSNP_analysis_table/all_results_table.tsv")
```

### compare to raw data

```{r}
grand_summary <- read.delim("./2021_08_24-Grand_Summary - MAP_analysis_summary.tsv")
```


```{r}
list_of_87 <- read.delim("list_87_strains.txt", header = F)
mean_doc <- grand_summary %>%
  mutate(Sample = sub("-WGS","",Sample)) %>%
  mutate(Sample = sub("Rs","R",Sample)) %>%
  mutate(Sample = sub("Vs","V",Sample)) %>%
  filter(Sample %in% list_of_87$V1) %>%
  select(Sample,Subject,Body.Site,Mean.depth.of.coverage,intermediate_SNPs)

```

```{r}
#Figure W3
ggplot(mean_doc,aes(x=Body.Site,y=Mean.depth.of.coverage)) +
  geom_boxplot() +
  theme_bw()
```


```{r}
ggplot(mean_doc,aes(x=Mean.depth.of.coverage,y=intermediate_SNPs)) +
  geom_point()+
  theme_bw() +
  ggtitle("Numbers of intermediate SNPs versus sample depth of coverage")
```


```{r}
RI_SNPs <- res_table %>% 
  select(subject_name,RonlyRI,ConlyRI,VonlyRI) %>%
  gather("site","SNPs",-subject_name) %>%
  mutate(Sample = case_when(site == "RonlyRI" ~ paste0(subject_name,"R"),
                                site == "ConlyRI" ~ paste0(subject_name,"C"),
                                site == "VonlyRI" ~ paste0(subject_name,"V")
                                )) %>% 
  inner_join(.,mean_doc, by = "Sample")
```

```{r}
ggplot(RI_SNPs,aes(x=Mean.depth.of.coverage,y=SNPs)) +
  geom_point()+
  theme_bw() +
  ggtitle("Numbers of rare intermediate SNPs versus sample depth of coverage")
```



```{r}
RI_SNPs %>% filter(Mean.depth.of.coverage > 1000) %>%
  filter(SNPs > 0)
```


```{r}
F_SNPs <- res_table %>% 
  select(subject_name,RonlyF,ConlyF,VonlyF) %>%
  gather("site","SNPs",-subject_name) %>%
  mutate(Sample = case_when(site == "RonlyF" ~ paste0(subject_name,"R"),
                                site == "ConlyF" ~ paste0(subject_name,"C"),
                                site == "VonlyF" ~ paste0(subject_name,"V")
                                )) %>% 
  inner_join(.,mean_doc, by = "Sample")
```


```{r}
ggplot(F_SNPs,aes(x=Mean.depth.of.coverage,y=SNPs)) +
  geom_point()+
  theme_bw() +
  ggtitle("Numbers of fixed SNPs versus sample depth of coverage")
```
```{r}
Supplemental_Table_3 <- read.delim("~/GitHub/Ct_MAP_analysis/Supplemental_Table_3-2022-06-12.tsv") %>%
  select(c(1:5))
Supp_Table_3_res <- inner_join(Supplemental_Table_3,res_table, by = c("Participant"="subject_name"))
write_tsv(Supp_Table_3_res, file = "new_supplementary_table3.tsv")
```

Venn Diagram 1
```{r}
venn_tab1 <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  select(Participant,RonlyFrare,ConlyFrare,VonlyFrare,RConlyFrare,VConlyFrare,RVonlyFrare) %>%
  mutate(RonlyFrare = ifelse(RonlyFrare > 0,paste0(Participant,"R",RonlyFrare),"")) %>%
  mutate(VonlyFrare = ifelse(VonlyFrare > 0,paste0(Participant,"V",VonlyFrare),"")) %>%
  mutate(ConlyFrare = ifelse(ConlyFrare > 0,paste0(Participant,"C",ConlyFrare),"")) %>%
  mutate(RConlyFrare = ifelse(RConlyFrare > 0,paste0(Participant,"RC",RConlyFrare),"")) %>%
  mutate(VConlyFrare = ifelse(VConlyFrare > 0,paste0(Participant,"VC",VConlyFrare),"")) %>%
  mutate(RVonlyFrare = ifelse(RVonlyFrare > 0,paste0(Participant,"RV",RVonlyFrare),""))
fixed_mutations <- as.vector(as.matrix(venn_tab1[,c("RonlyFrare","ConlyFrare","VonlyFrare","RConlyFrare","VConlyFrare","RVonlyFrare")]))
fixed_mutations <- fixed_mutations[fixed_mutations != ""]

C_strains <- c(str_which(fixed_mutations,"C"),venn_tab1$Participant)
R_strains <- c(str_which(fixed_mutations,"R"),venn_tab1$Participant)
V_strains <- c(str_which(fixed_mutations,"V"),venn_tab1$Participant)

library(VennDiagram)
library(RColorBrewer)
myCol <- brewer.pal(3,"Accent")
venn.diagram(
        x = list(C_strains, R_strains, V_strains),
        category.names = c("Endocervix" , "Rectum " , "Vagina"),
        filename = 'VennFig1.png',
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 480 , 
        width = 480 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .6,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.6,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1
)
```
Venn diagram 2

```{r}
venn_tab2 <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  select(Participant,RonlyFrare,ConlyFrare,VonlyFrare,RConlyFrare,VConlyFrare,RVonlyFrare,RonlyF_VIrare,RonlyF_CIrare,ConlyF_RIrare,ConlyF_VIrare,VonlyF_RIrare,VonlyF_CIrare) %>%
  mutate(RonlyFrare = ifelse(RonlyFrare > 0,paste0(Participant,"R",RonlyFrare),"")) %>%
  mutate(VonlyFrare = ifelse(VonlyFrare > 0,paste0(Participant,"V",VonlyFrare),"")) %>%
  mutate(ConlyFrare = ifelse(ConlyFrare > 0,paste0(Participant,"C",ConlyFrare),"")) %>%
  mutate(RConlyFrare = ifelse(RConlyFrare > 0,paste0(Participant,"RC",RConlyFrare),"")) %>%
  mutate(VConlyFrare = ifelse(VConlyFrare > 0,paste0(Participant,"VC",VConlyFrare),"")) %>%
  mutate(RVonlyFrare = ifelse(RVonlyFrare > 0,paste0(Participant,"RV",RVonlyFrare),"")) %>%
  mutate(RonlyF_VIrare = ifelse(RonlyF_VIrare > 0,paste0(Participant,"RVI",RonlyF_VIrare),"")) %>%
  mutate(RonlyF_CIrare = ifelse(RonlyF_CIrare > 0,paste0(Participant,"RCI",RonlyF_CIrare),"")) %>%
  mutate(ConlyF_VIrare = ifelse(ConlyF_VIrare > 0,paste0(Participant,"CVI",ConlyF_VIrare),"")) %>%
  mutate(ConlyF_RIrare = ifelse(ConlyF_RIrare > 0,paste0(Participant,"CRI",ConlyF_RIrare),"")) %>%
  mutate(VonlyF_CIrare = ifelse(VonlyF_CIrare > 0,paste0(Participant,"VCI",VonlyF_CIrare),"")) %>%
  mutate(VonlyF_RIrare = ifelse(VonlyF_RIrare > 0,paste0(Participant,"VRI",VonlyF_RIrare),""))

fixed_mutations2 <- as.vector(as.matrix(venn_tab2[,c("RonlyFrare","ConlyFrare","VonlyFrare","RConlyFrare","VConlyFrare","RVonlyFrare","RonlyF_VIrare","RonlyF_CIrare","ConlyF_RIrare","ConlyF_VIrare","VonlyF_RIrare","VonlyF_CIrare")]))
fixed_mutations2 <- fixed_mutations2[fixed_mutations2 != ""]

C_strains2 <- c(str_which(fixed_mutations2,"C"),venn_tab2$Participant)
R_strains2 <- c(str_which(fixed_mutations2,"R"),venn_tab2$Participant)
V_strains2 <- c(str_which(fixed_mutations2,"V"),venn_tab2$Participant)



```

```{r}
library(VennDiagram)
library(RColorBrewer)
myCol <- brewer.pal(3,"Accent")
venn.diagram(
        x = list(C_strains2, R_strains2, V_strains2),
        category.names = c("Endocervix" , "Rectum " , "Vagina"),
        filename = 'VennFig2.png',
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 480 , 
        width = 480 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .4,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.4,
        cat.fontface = "bold",
        cat.default.pos = "text",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1
)
```



# stats used in the paper

```{r}
gpA_rectal_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RonlyF > 0) %>%
  nrow()
gpA_vaginal_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VonlyF > 0) %>%
  nrow() 
gpA_endocervical_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(ConlyF > 0) %>%
  nrow()
gpA_RC_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RConlyF > 0) %>%
  nrow()
gpA_RV_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RVonlyF > 0) %>%
  nrow()
gpA_VC_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VConlyF > 0) %>%
  nrow()
gpA_RC_rareI <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RConlyRIrare > 0) %>%
  nrow()
gpA_RV_rareI <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RVonlyRIrare > 0) %>%
  nrow()
gpA_VC_rareI <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VConlyRIrare > 0) %>%
  nrow()

gpA_R_fixed_rareC <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RonlyF_CIrare > 0 | RonlyF_CandVIrare > 0) %>%
  nrow()
gpA_R_fixed_rareV <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RonlyF_VIrare > 0 | RonlyF_CandVIrare > 0) %>%
  nrow()

gpA_C_fixed_rareR <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(ConlyF_RIrare > 0 | ConlyF_RandVIrare > 0) %>%
  nrow()
gpA_C_fixed_rareV <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(ConlyF_VIrare > 0 | ConlyF_RandVIrare > 0) %>%
  nrow()

gpA_V_fixed_rareR <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VonlyF_RIrare > 0 | VonlyF_CandRIrare > 0) %>%
  nrow()
gpA_V_fixed_rareC <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VonlyF_CIrare > 0 | VonlyF_CandRIrare > 0) %>%
  nrow()
```
"Only `r gpA_rectal_fixed` Group A participants had a rectal sample with a fixed SNP"

"Only `r gpA_vaginal_fixed` Group A participants had a vaginal sample with a fixed SNP"

"Only `r gpA_endocervical_fixed` Group A participants had a endocervical sample with a fixed SNP"

"Only `r gpA_RC_fixed` Group A participants had fixed SNP in both rectal and endocervix"

"Only `r gpA_RV_fixed` Group A participants had fixed SNP in both rectal and vagina"

"Only `r gpA_VC_fixed` Group A participants had fixed SNP in both endocervix and vagina"

"Only `r gpA_RC_rareI` Group A participants had rare intermediate SNVs in both rectum and endocervix"

"Only `r gpA_RV_rareI` Group A participants had rare intermediate SNVs in both rectum and vagina"

"Only `r gpA_VC_rareI` Group A participants had rare intermediate SNVs in both vagina and endocervix"

"Table 2. `r gpA_R_fixed_rareC` Rectal fixed SNP, rare SNV in endocervix"

"Table 2. `r gpA_R_fixed_rareV` Rectal fixed SNP, rare SNV in vagina"

"Table 2. `r gpA_C_fixed_rareR` Endocervix fixed SNP, rare SNV in rectum"

"Table 2. `r gpA_C_fixed_rareV` Endocervix fixed SNP, rare SNV in vagina"

"Table 2. `r gpA_V_fixed_rareR` Vagina fixed SNP, rare SNV in rectum"

"Table 2. `r gpA_V_fixed_rareC` Vagina fixed SNP, rare SNV in endocervix"
