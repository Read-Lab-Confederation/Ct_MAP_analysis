---
title: "R Notebook"
output: html_notebook
---


```{r}
subject_id <- "908"
```

# Compare iSNP distributions in subject 

```{r}
library(tidyverse)
source("MAP_functions.R")
```

```{r}
Pos_count <- read_delim("Pos_count.tsv", show_col_types = FALSE)
rare_iSNPs <- Pos_count %>% filter(n<4) %>%
  .$Position
common_iSNPs <- Pos_count %>% filter(n>3) %>%
  .$Position
```

```{r}
recomb_coords <- function(fiji_df,samp_name){
  tmp_df <- fiji_df %>% 
    filter(c1 == samp_name | c2 == samp_name) %>% 
    select(Start,End)
  if (nrow(tmp_df)==0) {
    return(vector())
  }
  else {
    result <- vector()
    for (i in 1:nrow(tmp_df)) {
      result <- c(result,seq(tmp_df$Start[i],tmp_df$End[i]))
    }
    return(result)
  }
}
```


```{r}
fastgear_fiji_recombs <- read.delim("~/GitHub/Ct_MAP_analysis/fastgear_fiji_recombs") %>%
  select(Start,End,...1,...2)
colnames(fastgear_fiji_recombs) <- c("Start","End","c1","c2")

R_name = paste0(subject_id,"R")
V_name = paste0(subject_id,"V")
C_name = paste0(subject_id,"C")

C_recomb <- recomb_coords(fastgear_fiji_recombs,C_name)
R_recomb <- recomb_coords(fastgear_fiji_recombs,R_name)
V_recomb <- recomb_coords(fastgear_fiji_recombs,V_name)
```


These get the sites above Cov = 10 and with no weirdness
```{r}
R_MAP <- read_MAP(paste0("~/Documents/2021-Fiji-Ct_paper/MAP_results/MAP_files/",subject_id,"R_MAP.txt"),"R") %>%
    filter(regular > -1 & regular < 1) %>%
    filter(Coverage > 10) %>%
    select(Position,SNP_percent)

C_MAP <- read_MAP(paste0("~/Documents/2021-Fiji-Ct_paper/MAP_results/MAP_files/",subject_id,"C_MAP.txt"),"C") %>%
    filter(regular > -1 & regular < 1) %>%
    filter(Coverage > 10) %>%
    select(Position,SNP_percent)

V_MAP <- read_MAP(paste0("~/Documents/2021-Fiji-Ct_paper/MAP_results/MAP_files/",subject_id,"V_MAP.txt"),"V") %>%
    filter(regular > -1 & regular < 1) %>%
    filter(Coverage > 10) %>%
    select(Position,SNP_percent)
```

Join all 3 together and parse out the rare sites (ie < 90% in any of the 3)

```{r}
Total_iSNPs <- inner_join(R_MAP,V_MAP, by = "Position") %>%
  inner_join(.,C_MAP, by = "Position") %>%
  filter(!(SNP_percent.x > 90 & SNP_percent.y > 90 & SNP_percent > 90)) %>%
  mutate(SNP = case_when(
    Position %in% c(R_recomb,C_recomb,V_recomb) ~ "fastGEAR_block",
    Position %in% rare_iSNPs ~ "rare_iSNP",
    Position %in% common_iSNPs ~ "common_iSNP",
    TRUE ~ "other_SNP"
  ))

colnames(Total_iSNPs) <- c("Position","R_percent","V_percent","C_percent","SNP")
```
### SNPs
R only fixed (sum of other_SNPs & rare_iSNPs)
```{r}
Total_iSNPs %>%
  filter(R_percent < 10 & V_percent >= 90 & C_percent >= 90) %>%
  group_by(SNP) %>%
  tally()

RonlyF <- Total_iSNPs %>%
  filter(R_percent < 10 & V_percent >= 90 & C_percent >= 90) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP") %>%
  nrow()

```
R only rare_iSNP
```{r}
Total_iSNPs %>%
  filter(R_percent >= 10 & R_percent < 90 & V_percent >= 90 & C_percent >= 90) %>%
  group_by(SNP) %>%
  tally()

RonlyRI <- Total_iSNPs %>%
  filter(R_percent >= 10 & R_percent < 90 & V_percent >= 90 & C_percent >= 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()

```
C only fixed (sum of other_SNPs & rare_iSNPs)
```{r}
Total_iSNPs %>%
  filter(C_percent < 10 & V_percent >= 90 & R_percent >= 90) %>%
  group_by(SNP) %>%
  tally()

ConlyF <- Total_iSNPs %>%
  filter(C_percent < 10 & V_percent >= 90 & R_percent >= 90) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP") %>%
  nrow()
```
C only rare_iSNP 
```{r}
Total_iSNPs %>%
  filter(C_percent >= 10 & C_percent < 90 & V_percent >= 90 & R_percent >= 90) %>%
  group_by(SNP) %>%
  tally()

ConlyRI <- Total_iSNPs %>%
  filter(C_percent >= 10 & C_percent < 90 & V_percent >= 90 & R_percent >= 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()

```
V only fixed (sum of other_SNPs & rare_iSNPs)
```{r}
Total_iSNPs %>%
  filter(V_percent < 10 & C_percent >= 90 & R_percent >= 90) %>%
  group_by(SNP) %>%
  tally()

VonlyF <- Total_iSNPs %>%
  filter(V_percent < 10 & C_percent >= 90 & R_percent >= 90) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP") %>%
  nrow()
```
V only rare_iSNP
```{r}
Total_iSNPs %>%
  filter(V_percent >= 10 & V_percent < 90 & C_percent >= 90 & R_percent >= 90) %>%
  group_by(SNP) %>%
  tally()

VonlyRI <- Total_iSNPs %>%
  filter(V_percent >= 10 & V_percent < 90 & C_percent >= 90 & R_percent >= 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()
```
RC only fixed (sum of other_SNPs & rare_iSNPs)
```{r}
Total_iSNPs %>%
  filter(V_percent >= 90 & C_percent < 10 & R_percent < 10) %>%
  group_by(SNP) %>%
  tally()

RConlyF <- Total_iSNPs %>%
  filter(V_percent >= 90 & C_percent < 10 & R_percent < 10) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP") %>%
  nrow()
```

RC only intermediate
```{r}
Total_iSNPs %>%
  filter(V_percent >= 90 & C_percent >= 10 & C_percent < 90 & R_percent >= 10 & R_percent < 90) %>%
  group_by(SNP) %>%
  tally()

RConlyRI <- Total_iSNPs %>%
  filter(V_percent >= 90 & C_percent >= 10 & C_percent < 90 & R_percent >= 10 & R_percent < 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()
```
RV only fixed
```{r}
Total_iSNPs %>%
  filter(C_percent >= 90 & V_percent < 10 & R_percent < 10) %>%
  group_by(SNP) %>%
  tally()

RVonlyF <- Total_iSNPs %>%
  filter(C_percent >= 90 & V_percent < 10 & R_percent < 10) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP") %>%
  nrow()
```
RV only intermediate
```{r}
Total_iSNPs %>%
  filter(C_percent >= 90 & V_percent >= 10 & V_percent < 90 & R_percent >= 10 & R_percent < 90) %>%
  group_by(SNP) %>%
  tally()

RVonlyRI <- Total_iSNPs %>%
  filter(C_percent >= 90 & V_percent >= 10 & V_percent < 90 & R_percent >= 10 & R_percent < 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()
```
VC only fixed
```{r}
Total_iSNPs %>%
  filter(R_percent >= 90 & V_percent < 10 & C_percent < 10) %>%
  group_by(SNP) %>%
  tally()

VConlyF <- Total_iSNPs %>%
  filter(R_percent >= 90 & V_percent < 10 & C_percent < 10) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP") %>%
  nrow()
```
VC only intermediate
```{r}
Total_iSNPs %>%
  filter(R_percent >= 90 & V_percent >= 10 & V_percent < 90 & C_percent >= 10 & C_percent < 90) %>%
  group_by(SNP) %>%
  tally()

VConlyRI <- Total_iSNPs %>%
  filter(R_percent >= 90 & V_percent >= 10 & V_percent < 90 & C_percent >= 10 & C_percent < 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()
```
all_fixed - inlcude common SNPs
```{r}
Total_iSNPs %>%
  filter(R_percent <10 & V_percent < 10 & C_percent < 10) %>%
  group_by(SNP) %>%
  tally()

AllF <- Total_iSNPs %>%
  filter(R_percent <10 & V_percent < 10 & C_percent < 10) %>%
  filter(SNP == "other_SNP" | SNP == "rare_iSNP" | SNP == "common_iSNP" ) %>%
  nrow()
```
all intermediate
```{r}
Total_iSNPs %>%
  filter(R_percent >= 10 & R_percent < 90 & V_percent >= 10 & V_percent < 90 & C_percent >= 10 & C_percent < 90) %>%
  group_by(SNP) %>%
  tally()

AllRI <- Total_iSNPs %>%
  filter(R_percent >= 10 & R_percent < 90 & V_percent >= 10 & V_percent < 90 & C_percent >= 10 & C_percent < 90) %>%
  filter(SNP == "rare_iSNP") %>%
  nrow()
```
## Summarise and write SNP table
```{r}
result_table <- data.frame(subject_name = subject_id,AllF,AllRI,RonlyF,RonlyRI,ConlyF,ConlyRI,VonlyF,VonlyRI,RConlyF,RConlyRI,RVonlyF,RVonlyRI,VConlyF,VConlyRI)
result_table
outfile <- paste0("./iSNP_analysis_table/iSNPs_",subject_id,".tsv")
write_tsv(result_table,outfile)
```


## Tryptich

```{r}
library(cowplot)

RCplot <- ggplot(filter(Total_iSNPs,!(R_percent > 90 & C_percent > 90)), aes(x=R_percent, y=C_percent, color = SNP)) + 
  geom_point() +
  xlab("Ref allele % rectal") +
  ylab("Ref allele % cervical") +
  xlim(0,100) + 
  scale_color_manual(values = c("gainsboro","orange","red","blue")) +
  theme_bw() 
  
RVplot <- ggplot(filter(Total_iSNPs,!(R_percent > 90 & V_percent > 90)), aes(x=R_percent, y=V_percent, color = SNP)) + 
  geom_point() +
  xlab("Ref allele % rectal") +
  ylab("Ref allele % vaginal") +
  xlim(0,100) +
  scale_color_manual(values = c("gainsboro","orange","red","blue")) +
  theme_bw() 
  
VCplot <- ggplot(filter(Total_iSNPs,!(V_percent > 90 & C_percent > 90)), aes(x=V_percent, y=C_percent, color = SNP)) + 
  geom_point() +
  xlab("Ref allele % vaginal") +
  ylab("Ref allele % cervical") +
  xlim(0,100) +
  scale_color_manual(values = c("gainsboro","orange","red","blue")) +
  theme_bw() 

## cowplot 
plot_grid(
  RCplot, RVplot, VCplot,
  labels = c("a","b","c")
)
```
## Plot of each pair
```{r}
RCplot +
  labs(title = paste("Minor SNPs in R(x) versus C(y). Subject:",subject_id))
```

```{r}
RVplot +
  labs(title = paste("Minor SNPs in R(x) versus V(y). Subject:",subject_id))
```

```{r}
VCplot +
  labs(title = paste("Minor SNPs in V(x) versus C(y). Subject:",subject_id))
```