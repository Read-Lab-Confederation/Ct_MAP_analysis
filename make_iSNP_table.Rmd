---
title: "make_iSNP_table.Rmd"
output: html_document
---

```{r}
library(tidyverse)
```


```{r}
res_files <- list.files("./iSNP_analysis_table/",full.names = T, pattern = "iSNP*")
res_table <- read.delim(res_files[1])
for (i in 2:length(res_files)){
  temp_df <- read.delim(res_files[i])
  res_table <- bind_rows(res_table,temp_df)
}
```

```{r}
write_tsv(res_table,"./iSNP_analysis_table/all_results_table.tsv")
```

### compare to raw data

```{r}
grand_summary <- read.delim("./2021_08_24-Grand_Summary - MAP_analysis_summary.tsv")
```


```{r}
list_of_87 <- read.delim("list_87_strains.txt", header = F)
mean_doc <- grand_summary %>%
  mutate(Sample = sub("-WGS","",Sample)) %>%
  mutate(Sample = sub("Rs","R",Sample)) %>%
  mutate(Sample = sub("Vs","V",Sample)) %>%
  filter(Sample %in% list_of_87$V1) %>%
  select(Sample,Subject,Body.Site,Mean.depth.of.coverage,intermediate_SNPs)

```

```{r}
#Figure W3
ggplot(mean_doc,aes(x=Body.Site,y=Mean.depth.of.coverage)) +
  geom_boxplot() +
  theme_bw()
```


```{r}
ggplot(mean_doc,aes(x=Mean.depth.of.coverage,y=intermediate_SNPs)) +
  geom_point()+
  theme_bw() +
  ggtitle("Numbers of intermediate SNPs versus sample depth of coverage")
```


```{r}
RI_SNPs <- res_table %>% 
  select(subject_name,RonlyRI,ConlyRI,VonlyRI) %>%
  gather("site","SNPs",-subject_name) %>%
  mutate(Sample = case_when(site == "RonlyRI" ~ paste0(subject_name,"R"),
                                site == "ConlyRI" ~ paste0(subject_name,"C"),
                                site == "VonlyRI" ~ paste0(subject_name,"V")
                                )) %>% 
  inner_join(.,mean_doc, by = "Sample")
```

```{r}
ggplot(RI_SNPs,aes(x=Mean.depth.of.coverage,y=SNPs)) +
  geom_point()+
  theme_bw() +
  ggtitle("Numbers of rare intermediate SNPs versus sample depth of coverage")
```



```{r}
RI_SNPs %>% filter(Mean.depth.of.coverage > 1000) %>%
  filter(SNPs > 0)
```


```{r}
F_SNPs <- res_table %>% 
  select(subject_name,RonlyF,ConlyF,VonlyF) %>%
  gather("site","SNPs",-subject_name) %>%
  mutate(Sample = case_when(site == "RonlyF" ~ paste0(subject_name,"R"),
                                site == "ConlyF" ~ paste0(subject_name,"C"),
                                site == "VonlyF" ~ paste0(subject_name,"V")
                                )) %>% 
  inner_join(.,mean_doc, by = "Sample")
```


```{r}
ggplot(F_SNPs,aes(x=Mean.depth.of.coverage,y=SNPs)) +
  geom_point()+
  theme_bw() +
  ggtitle("Numbers of fixed SNPs versus sample depth of coverage")
```
```{r}
Supplemental_Table_3 <- read.delim("~/GitHub/Ct_MAP_analysis/Supplemental_Table_3-2022-06-12.tsv") %>%
  select(c(1:5))
Supp_Table_3_res <- inner_join(Supplemental_Table_3,res_table, by = c("Participant"="subject_name"))
```

# stats used in the paper

```{r}
gpA_rectal_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RonlyF > 0) %>%
  nrow()
gpA_vaginal_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VonlyF > 0) %>%
  nrow() 
gpA_endocervical_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(ConlyF > 0) %>%
  nrow()
gpA_RC_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RConlyF > 0) %>%
  nrow()
gpA_RV_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RVonlyF > 0) %>%
  nrow()
gpA_VC_fixed <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VConlyF > 0) %>%
  nrow()
gpA_RC_rareI <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RConlyRIrare > 0) %>%
  nrow()
gpA_RV_rareI <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RVonlyRIrare > 0) %>%
  nrow()
gpA_VC_rareI <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VConlyRIrare > 0) %>%
  nrow()

gpA_R_fixed_rareC <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RonlyF_CIrare > 0 | RonlyF_CandVIrare > 0) %>%
  nrow()
gpA_R_fixed_rareV <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(RonlyF_VIrare > 0 | RonlyF_CandVIrare > 0) %>%
  nrow()

gpA_C_fixed_rareR <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(ConlyF_RIrare > 0 | ConlyF_RandVIrare > 0) %>%
  nrow()
gpA_C_fixed_rareV <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(ConlyF_VIrare > 0 | ConlyF_RandVIrare > 0) %>%
  nrow()

gpA_V_fixed_rareR <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VonlyF_RIrare > 0 | VonlyF_CandRIrare > 0) %>%
  nrow()
gpA_V_fixed_rareC <- Supp_Table_3_res %>%
  filter(Group == "A") %>%
  filter(VonlyF_CIrare > 0 | VonlyF_CandRIrare > 0) %>%
  nrow()
```

"Only `r gpA_rectal_fixed` Group A participants had a rectal sample with a fixed SNP"

"Only `r gpA_vaginal_fixed` Group A participants had a vaginal sample with a fixed SNP"

"Only `r gpA_endocervical_fixed` Group A participants had a endocervical sample with a fixed SNP"

"Only `r gpA_RC_fixed` Group A participants had fixed SNP in both rectal and endocervix"

"Only `r gpA_RV_fixed` Group A participants had fixed SNP in both rectal and vagina"

"Only `r gpA_VC_fixed` Group A participants had fixed SNP in both endocervix and vagina"

"Only `r gpA_RC_rareI` Group A participants had rare intermediate SNVs in both rectum and endocervix"

"Only `r gpA_RV_rareI` Group A participants had rare intermediate SNVs in both rectum and vagina"

"Only `r gpA_VC_rareI` Group A participants had rare intermediate SNVs in both vagina and endocervix"

"Table 2. `r gpA_R_fixed_rareC` Rectal fixed SNP, rare SNV in endocervix"

"Table 2. `r gpA_R_fixed_rareV` Rectal fixed SNP, rare SNV in vagina"

"Table 2. `r gpA_C_fixed_rareR` Endocervix fixed SNP, rare SNV in rectum"

"Table 2. `r gpA_C_fixed_rareV` Endocervix fixed SNP, rare SNV in vagina"

"Table 2. `r gpA_V_fixed_rareR` Vagina fixed SNP, rare SNV in rectum"

"Table 2. `r gpA_V_fixed_rareC` Vagina fixed SNP, rare SNV in endocervix"
